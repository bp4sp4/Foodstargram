<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
</head>

<body>
    <h1 class="title">FoodStargram</h1>
    <header>
        <i id="homeBtn" class="bi bi-house"></i>
        <i id="plusBtn" class="bi bi-plus-circle"></i>
    </header>
    
    <!-- 게시글 작성 -->
    <main class="wrap">
        <div class="dialog" id="modal">
            <div class="tb">
                <div class="inner" style="max-width:800px;">
                    <div class="top">
                        <span class="close">&times;</span>
                        <button id="saveBtn" class="saveBtn">공유하기</button>
                    </div>
                    <div class="ct">
                        <div class="ct__file">
                            <p>사진을 여기에 끌어다 놓으세요</p>
                            <div id="btnIcon" class="btn-upload">사진 업로드하기</div>
                            <input id="fileInput" type="file" name="file" style="display:none;">
                        </div>
                        <div class="ct__contents">
                            <input id="titleInput" type="text" placeholder="제목을 입력하세요." name="title">
                            <textarea id="contentsInput" placeholder="내용을 입력하세요."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 게시글 리스트 -->
        <div class="post__container">
            <div class="post-list">
                <ul>
                    <li th:each="card : ${cardViewList}">
                        <div class="post__item instagram__post">
                            <div class="post__nickname">
                                <p class="post__comments__user" th:text="${card.loginId}">user001</p>
                                <i th:if="${card.userId == session.userId}" class="bi bi-three-dots-vertical more-btn" th:data-post-id="${card.postId}" data-toggle="modal" data-target="#exampleModalCenter"></i> 
                            </div>
                            <div class="post__image">
                                <img th:src="${card.imagePath}" alt="Post Image" class="post__image__content" />
                            </div>
                            <div class="post__like">
                                <i th:if="${card.isLike}" class="bi bi-suit-heart-fill unlikeBtn" th:data-post-id="${card.postId}"></i>
                                <i th:unless="${card.isLike}" class="bi bi-suit-heart likeBtn" th:data-post-id="${card.postId}"></i>
                                &nbsp;
                                <span id="likeCount" th:text="| 좋아요 ${card.likeCount}개 |">11개</span>
                            </div>
                            <div class="post__content">
                                <span class="post__comments__user">user001</span>
                                <span th:text="${card.contents}"></span>
                            </div>
                            <div class="post__allcomments">
                                <span>댓글 모두 보기</span>
                            </div>
                            <div class="post__comments" th:each="comment : ${card.commentList}">
                                <b th:text="${comment.loginId}"></b> <span class="post__comments__user" th:text="${comment.contents}">user003</span>
                            </div>
                            <div>
                                <input type="text" class="comment__form" th:id="|commentInput${card.postId}|"/>
                                <button type="button" class="comment-btn" th:data-post-id="${card.postId}">게시</button>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- 삭제 모달 -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <a href="#" id="deleteBtn" th:data-post-id>삭제하기</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    
    <script>
        // 모달 처리
        const modal = document.getElementById('modal');
        const plusBtn = document.getElementById('plusBtn');
        const closeBtn = document.querySelector('.close');

        plusBtn.onclick = function() {
            modal.style.display = 'block';
        }

        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // 문서가 준비되었을 때 이벤트 처리
        $(document).ready(function() {
            // 삭제 버튼 클릭 처리
            $(document).on("click", "#deleteBtn", function() {
                let postId = $(this).data("post-id");

                $.ajax({
                    type: "DELETE",
                    url: "/post/delete",
                    data: { "id": postId },
                    success: function(data) {
                        if (data.result == "success") {
                            location.reload();
                        } else {
                            alert("삭제 실패!!");
                        }
                    },
                    error: function() {
                        alert("삭제 에러!!");
                    }
                });
            });

            // 더보기 버튼 클릭 시 삭제 버튼에 post-id 전달
            $(document).on("click", ".more-btn", function() {
                let postId = $(this).data("post-id");
                $("#deleteBtn").data("post-id", postId);
            });

            // 댓글 작성 버튼 클릭 처리
            $(document).on("click", ".comment-btn", function() {
                let postId = $(this).data("post-id");
                let contents = $("#commentInput" + postId).val();

                $.ajax({
                    type: "POST",
                    url: "/post/comment/create",
                    data: { "postId": postId, "contents": contents },
                    success: function(data) {
                        if (data.result == "success") {
                            location.reload();
                        } else {
                            alert("댓글 작성 실패!!");
                        }
                    },
                    error: function() {
                        alert("댓글 작성 에러!!");
                    }
                });
            });

            // 좋아요 버튼 처리
            $(document).on("click", ".likeBtn", function() {
                let postId = $(this).data("post-id");

                $.ajax({
                    type: "POST",
                    url: "/post/like",
                    data: { "postId": postId },
                    success: function(data) {
                        if (data.result == "success") {
                            location.reload();
                        } else {
                            alert("좋아요 실패!!");
                        }
                    },
                    error: function() {
                        alert("좋아요 에러!!");
                    }
                });
            });

            // 좋아요 취소 버튼 처리
            $(document).on("click", ".unlikeBtn", function() {
                let postId = $(this).data("post-id");

                $.ajax({
                    type: "DELETE",
                    url: "/post/unlike",
                    data: { "postId": postId },
                    success: function(data) {
                        if (data.result == "success") {
                            location.reload();
                        } else {
                            alert("좋아요 취소 실패!!");
                        }
                    },
                    error: function() {
                        alert("좋아요 취소 에러!!");
                    }
                });
            });

            // 파일 업로드 버튼 처리
            $("#btnIcon").on("click", function() {
                $("#fileInput").click();
            });

            // 게시글 작성 및 업로드 처리
            $("#saveBtn").on("click", function() {
                let title = $("#titleInput").val();
                let contents = $("#contentsInput").val();
                let formData = new FormData();
                formData.append("title", title);
                formData.append("contents", contents);
                formData.append("file", $("#fileInput")[0].files[0]);

                $.ajax({
                    type: "POST",
                    url: "/post/create",
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function(data) {
                        if (data.result == "success") {
                            location.reload();
                        } else {
                            alert("게시글 작성 실패!!");
                        }
                    },
                    error: function() {
                        alert("게시글 작성 에러!!");
                    }
                });
            });
        });
    </script>
</body>
</html>
